<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Гидравлический расчет АУП</title>
    <style>
        @page {
            size: A4;
            margin: 1.5cm;
        }

        body {
            font-family: 'DejaVu Sans', Arial, sans-serif;
            font-size: 10pt;
            line-height: 1.3;
            color: #000;
        }

        h1 {
            color: #000;
            font-size: 16pt;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        h2 {
            color: #000;
            font-size: 13pt;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: bold;
            border-bottom: 1px solid #000;
            padding-bottom: 3px;
        }

        h3 {
            color: #000;
            font-size: 11pt;
            margin-top: 12px;
            margin-bottom: 6px;
            font-weight: bold;
        }

        .meta-info {
            font-size: 9pt;
            margin-bottom: 20px;
            text-align: right;
            color: #666;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0 15px 0;
            page-break-inside: avoid;
            font-size: 9pt;
        }

        table th {
            background-color: #e0e0e0;
            border: 1px solid #000;
            padding: 6px 4px;
            text-align: center;
            font-weight: bold;
        }

        table td {
            padding: 5px 4px;
            border: 1px solid #000;
            text-align: left;
        }

        table.params-table td:first-child {
            font-weight: bold;
            width: 70%;
        }

        table.params-table td:last-child {
            text-align: right;
            width: 30%;
        }

        table tbody tr:nth-child(even) {
            background-color: #f5f5f5;
        }

        .section {
            margin-bottom: 20px;
            page-break-inside: avoid;
        }

        .param-box {
            padding: 8px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }

        .param-label {
            font-weight: bold;
        }

        .branch-header {
            background-color: #d9ead3;
            padding: 6px;
            margin-top: 10px;
            font-weight: bold;
        }

        .connection-header {
            background-color: #fff2cc;
            padding: 6px;
            margin-top: 10px;
            font-weight: bold;
        }

        .feed-pipe-header {
            background-color: #f4cccc;
            padding: 6px;
            margin-top: 10px;
            font-weight: bold;
        }

        .hydraulic-table {
            font-size: 8pt;
        }

        .hydraulic-table th {
            padding: 4px 2px;
            font-size: 8pt;
        }

        .hydraulic-table td {
            padding: 3px 2px;
            text-align: center;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="meta-info">
        Дата: {{ result.created_at|date:"d.m.Y H:i:s" }}
    </div>

    <h1>ГИДРАВЛИЧЕСКИЙ РАСЧЕТ<br>АВТОМАТИЧЕСКОЙ УСТАНОВКИ ПОЖАРОТУШЕНИЯ</h1>

    <!-- 1. Параметры помещения -->
    <div class="section">
        <h2>1. Параметры защищаемого помещения</h2>

        {% if result.data.formValues %}
        <table class="params-table">
            <tr>
                <td>Группа защищаемого помещения</td>
                <td>{{ result.data.formValues.group|default:"-" }}</td>
            </tr>
            <tr>
                <td>Вид ОТВ</td>
                <td>
                    {% if result.data.formValues.otv == "water" %}вода
                    {% elif result.data.formValues.otv == "foam" %}раствор пенообразователя
                    {% elif result.data.formValues.otv == "water_plus" %}вода со смачивателем
                    {% else %}{{ result.data.formValues.otv }}{% endif %}
                </td>
            </tr>
            <tr>
                <td>Высота помещения, м</td>
                <td>{{ result.data.formValues.height|default:"-" }}</td>
            </tr>
            {% if result.data.formValues.group == "5" or result.data.formValues.group == "6" %}
            <tr>
                <td>Высота складирования, м</td>
                <td>{{ result.data.formValues.sklad_height|default:"-" }}</td>
            </tr>
            {% endif %}
            <tr>
                <td>Минимальная температура воздуха, °С</td>
                <td>{{ result.data.formValues.temp|default:"-" }}</td>
            </tr>
            <tr>
                <td>Тип установки пожаротушения</td>
                <td>
                    {% if result.data.installationType == "sprinkler_water" %}Спринклерная водозаполненная
                    {% elif result.data.installationType == "sprinkler_air" %}Спринклерная воздушная
                    {% elif result.data.installationType == "drench" %}Дренчерная
                    {% else %}{{ result.data.installationType }}{% endif %}
                </td>
            </tr>
        </table>
        {% endif %}
    </div>

    <!-- 2. Подбор оросителя -->
    <div class="section">
        <h2>2. Подбор оросителя</h2>

        {% if result.data.sprinkler %}
        <table class="params-table">
            <tr>
                <td>Тип оросителя</td>
                <td>{{ result.data.sprinkler.type|default:"-" }}</td>
            </tr>
            <tr>
                <td>Давление на оросителе, МПа</td>
                <td>{{ result.data.sprinkler.pressure|default:"-" }}</td>
            </tr>
            <tr>
                <td>Расход через ороситель, л/с</td>
                <td>{{ result.data.sprinkler.flow|default:"-" }}</td>
            </tr>
            <tr>
                <td>Коэффициент производительности оросителя</td>
                <td>{{ result.data.sprinkler.k_factor|default:"-" }}</td>
            </tr>
        </table>
        {% else %}
        <p><em>Данные об оросителе не сохранены</em></p>
        {% endif %}

        <!-- График оросителя (если есть) -->
        {% if result.data.sprinkler.chart_data %}
        <h3>График зависимости средней интенсивности от давления</h3>
        <p><em>График будет добавлен в следующей версии</em></p>
        {% endif %}
    </div>

    <!-- 3. Гидравлический расчет ветвей -->
    <div class="section">
        <h2>3. Гидравлический расчет питающих ветвей</h2>

        {% if result.data.pipeType %}
        <div class="param-box">
            <span class="param-label">Тип трубы:</span> {{ result.data.pipeType }}<br>
            <span class="param-label">DN (диаметр):</span> {{ result.data.pipeDN|default:"-" }}<br>
            <span class="param-label">Геометрическая высота диктующего оросителя над осью пожарного насоса H, м:</span> {{ result.data.formValues.height|default:"-" }}<br>
            <span class="param-label">Удельная характеристика K:</span> {{ result.data.totalK|default:"-" }} л²/с²
        </div>
        {% endif %}

        {% if result.data.branchDetails %}
            {% for branch_key, branch_info in result.data.branchDetails.items %}
            <h3 class="mt-10">Ветка {{ branch_info.branch_num|default:branch_key }}</h3>

            <table class="hydraulic-table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Наименование</th>
                        <th style="width: 12%;">Длина, м</th>
                        <th style="width: 15%;">Потери давления, м</th>
                        <th style="width: 12%;">Расход, л/с</th>
                        <th style="width: 13%;">Давление, м</th>
                        <th style="width: 13%;">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% if branch_info.rows %}
                        {% for row in branch_info.rows %}
                        <tr {% if row.is_sprinkler %}style="background-color: #e8f0fe;"{% endif %}>
                            <td>{{ row.name }}</td>
                            <td class="text-center">{{ row.length|default:"-" }}</td>
                            <td class="text-center">{{ row.pressure_loss|default:"-" }}</td>
                            <td class="text-center">{{ row.flow|default:"-" }}</td>
                            <td class="text-center">{{ row.pressure|default:"-" }}</td>
                            <td class="text-center">{{ row.action|default:"-" }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="6"><em>Нет данных</em></td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>

            {% if branch_info.kt %}
            <p><strong>Коэффициент Kt:</strong> {{ branch_info.kt }}</p>
            {% endif %}
            {% endfor %}
        {% elif result.data.branches %}
            <!-- Fallback к старому формату -->
            {% for branch_num, branch_data in result.data.branches.items %}
            <div class="branch-header">Ветка {{ branch_num }}</div>

            <table class="hydraulic-table">
                <thead>
                    <tr>
                        <th>Наименование</th>
                        <th>Длина, м</th>
                        <th>Потери давления, м</th>
                        <th>Расход, л/с</th>
                        <th>Давление, м</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% if branch_data.results %}
                    <tr>
                        <td>Ветка {{ branch_num }}</td>
                        <td>{{ branch_data.results.length|default:"-" }}</td>
                        <td>{{ branch_data.results.P_loss|default:"-" }}</td>
                        <td>{{ branch_data.results.Q_total|default:"-" }}</td>
                        <td>{{ branch_data.results.P_total|default:"-" }}</td>
                        <td>-</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6"><em>Нет данных</em></td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>

            <p><strong>Коэффициент Kt:</strong> {{ branch_data.kt|default:"-" }}</p>
            {% endfor %}
        {% else %}
        <p><em>Данные о ветвях не сохранены</em></p>
        {% endif %}

        <!-- Участки между ветвями (соединения) -->
        {% if result.data.connections %}
        <h3 class="mt-10">Участки между ветвями</h3>
        {% for connection_key, connection_data in result.data.connections.items %}
        <div class="connection-header">{{ connection_key }}</div>

        {% if connection_data %}
        <table class="params-table">
            {% for key, value in connection_data.items %}
            <tr>
                <td>{{ key }}</td>
                <td>{{ value }}</td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <p><em>Нет данных</em></p>
        {% endif %}
        {% endfor %}
        {% endif %}
    </div>

    <!-- 4. Подающий трубопровод -->
    {% if result.data.feedPipe %}
    <div class="section">
        <h2>4. Подающий трубопровод</h2>

        <div class="feed-pipe-header">Подающий трубопровод</div>

        <table class="params-table">
            <tr>
                <td>Длина, м</td>
                <td>{{ result.data.feedPipe.length|default:"-" }}</td>
            </tr>
            <tr>
                <td>Коэффициент Kt</td>
                <td>{{ result.data.feedPipe.kt|default:"-" }}</td>
            </tr>
            {% if result.data.feedPipe.results %}
            <tr>
                <td>Расход (Q), л/с</td>
                <td>{{ result.data.feedPipe.results.Q_total|default:"-" }}</td>
            </tr>
            <tr>
                <td>Давление (P), м</td>
                <td>{{ result.data.feedPipe.results.P_total|default:"-" }}</td>
            </tr>
            {% endif %}
        </table>
    </div>
    {% endif %}

    <!-- 5. Подобранный узел управления -->
    {% if result.data.controlUnit %}
    <div class="section">
        <h2>5. Подобранный узел управления</h2>

        <div class="param-box">
            {{ result.data.controlUnit }}
        </div>
    </div>
    {% endif %}

    <!-- 6. Требуемые гидравлические параметры -->
    <div class="section">
        <h2>6. Требуемые гидравлические параметры</h2>

        <table class="params-table">
            <tr>
                <td>Требуемый расход, л/с</td>
                <td>
                    {% if result.data.feedPipe.results.Q_total %}
                        {{ result.data.feedPipe.results.Q_total }}
                    {% else %}-{% endif %}
                </td>
            </tr>
            <tr>
                <td>Требуемый напор, м</td>
                <td>
                    {% if result.data.feedPipe.results.P_total %}
                        {{ result.data.feedPipe.results.P_total }}
                    {% else %}-{% endif %}
                </td>
            </tr>
            <tr>
                <td>Общие потери давления, м</td>
                <td>
                    {% if result.data.totalLosses %}
                        {{ result.data.totalLosses }}
                    {% else %}-{% endif %}
                </td>
            </tr>
        </table>
    </div>

</body>
</html>
